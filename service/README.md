# QA System

## Контрольные вопросы
1. __Точно ли вы подняли все, что нужно QA системе? Если вы закодили все внутри одного приложения, то это не зачтется__
  <br>Да, сделал отдельное приложение [gateway](https://gitlab.com/hardml/qa-system/-/tree/main/gateway), куда будут поступать запросы от клиента. Отдельно поднимается контейнер с [tensorflow/serving:latest](https://hub.docker.com/r/tensorflow/serving) в качестве эмбеддера. А также поднимаются контейнеры из образа [indexer](https://gitlab.com/hardml/qa-system/-/tree/main/indexer), каждый из которых обрабатывает свой класс (кластер). Сервисы общаются между собой по API.
2. __Каким образом файлы с индексами попадают на целевые машины? Попадают ли индексы адресно или происходит broadcast одного файла на все сервера?__
  <br>На удаленную тачку заранее были загружены два индекса для имитации двух поколений. [Приложение](https://gitlab.com/hardml/index_updater) подкладывает нужное поколение в целевую директорию на этой же тачке. К этой директории маунтятся контейнеры с приложениями. К сожалению, мне пришлось порезать индексы, т.к падало по памяти. Сделал стратифицированное по классам разбиение. Для прода я бы докинул памяти на тачки, либо сделал больше тачек.
3. __Написали ли ли вы стратегию обновления индекса в системе? Что это за стратегия: Blue / Green или Rolling? А есть ли у вашей стратегии downtime?__
  <br>Да. Rolling стратегия с downtime 30 сек.
4. __При обновлении индекса обновляются ли необходимые параметры в других частях системы?
Т.е. не случится ли такого, что gateway направляет запрос не на тот индекс если во время обновления что то пошло не так? Не забыли ли вы про идемпотентность обновлений в вашей стратегии?__
  <br>Все контейнеры смотрят в одну целевую директорию. Поэтому не должно сломаться, т.к в эту директорию перезаписываются все нужные артефакты.
5. __Что будет, если индекс не сможет обновиться? (например, попался битый файл индекса)__
  <br>Будет сыпаться ```500 Internal Server Error``` при запросах на ```gateway```
6. __Может, вы не поленились и предусмотрели ли какие нибудь failover?__
  <br>Failover предусмотрен только при обновлении. Правда, если что-то не так с артефактами, то это не поможет.
7. __Вы использовали уже готовые инструменты, знакомые многим или решили написали свой shellсипед?__
  <br>Использовал ```docker swarm```. Сборка, доставка и запуск происходит автоматически при тригере ci/cd pipeline.
8. __А что с самими приложениями сервинга? Нет перегружен ли его запуск внешними зависимостями, правильно ли выключается и поднимается приложение. Существует способ быстро проверить здорово ли приложение?__
  <br>Для сервинга использовал docker образ ```tensorflow/serving:latest```.
  <br> Команды для ручного запуска/выключения/отладки приложения описаны в [Makefile](https://gitlab.com/hardml/qa-system/-/blob/main/Makefile). Но для этого потребуются доступы к тачкам: ```135.181.204.59 (VM #594)``` и ```65.108.144.165 (VM #592)```.
 <br> Для автоматического запуска можно [тригернуть](https://gitlab.com/api/v4/projects/38818157/ref/main/trigger/pipeline?token=glptt-9171fea52691dc41486dedee8f86a320e9332374
) ci/cd pipeline для запуска приложения. Или сделать запрос:
```bash
curl -X POST \
     --fail \
     -F token=glptt-9171fea52691dc41486dedee8f86a320e9332374 \
     -F "ref=main" \
     https://gitlab.com/api/v4/projects/38818157/trigger/pipeline
```
<br> Для мониторинга можно воспользоваться ```docker service ls``` и ```docker service logs```. 
<br> Тестовый вопрос можно отправить с помощью [py скрипта](https://gitlab.com/hardml/qa-system/-/blob/main/gateway/send_test_question.py)

